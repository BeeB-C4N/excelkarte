<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å ±é›†ç´„ãƒ»å€‹äººã‚«ãƒ«ãƒ†ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼šåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="xlsx.full.min.js"></script>
    <style>
        /* --- å¤–éƒ¨ä¾å­˜ãªã—ã®CSS --- */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
            margin: 0;
            line-height: 1.5;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 2.25rem; font-weight: 800; color: #1e293b; margin-bottom: 8px; }
        .subtitle { color: #64748b; }
        section { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .section-title { display: flex; align-items: center; font-size: 1.25rem; font-weight: bold; margin-bottom: 24px; }
        .step-number { background: #2563eb; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 0.875rem; }
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; background: #f8fafc; cursor: pointer; transition: all 0.2s; }
        .drop-zone:hover { border-color: #3b82f6; background: #eff6ff; }
        #fileInput { display: none; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
        .setting-card { padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
        .source-label { font-size: 0.625rem; font-weight: bold; color: #2563eb; text-transform: uppercase; margin-bottom: 4px; }
        .source-name { font-size: 0.875rem; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.875rem; }
        .search-box { display: flex; gap: 12px; margin-bottom: 30px; }
        input[type="text"] { flex-grow: 1; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 1rem; outline: none; }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: #1e293b; color: white; }
        .btn-success { background: #2563eb; color: white; font-size: 1.125rem; padding: 16px 40px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        #nameList { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .name-item { display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; cursor: pointer; }
        .a4-page { width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto 10mm auto; background: white; box-sizing: border-box; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .carte-header { border-bottom: 2px solid #1a365d; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .carte-title { font-size: 24px; font-weight: 900; margin: 0; color: #1a365d; }
        .patient-info { border: 2px solid #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: baseline; }
        .label-badge { font-size: 12px; background: #1e293b; color: white; padding: 4px 8px; margin-right: 16px; font-weight: bold; }
        .patient-name { font-size: 32px; font-weight: bold; }
        .record-card { border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 24px; overflow: hidden; break-inside: avoid; }
        .record-source { background: #f1f5f9; padding: 8px 16px; font-size: 11px; font-weight: bold; color: #475569; border-bottom: 1px solid #cbd5e1; }
        .item-row { display: flex; border-bottom: 1px solid #f1f5f9; }
        .item-label { width: 140px; background: #f8fafc; padding: 10px 15px; font-size: 12px; font-weight: bold; color: #64748b; border-right: 1px solid #f1f5f9; flex-shrink: 0; }
        .item-value { padding: 10px 15px; font-size: 14px; flex-grow: 1; white-space: pre-wrap; }
        #previewControls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 100; }
        .hidden { display: none !important; }
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #printArea { background: white; padding: 0; }
            .a4-page { margin: 0; box-shadow: none; width: 100%; }
            .page-break { page-break-after: always; }
            @page { size: A4 portrait; margin: 0; }
        }
    </style>
</head>
<body>

<div class="container no-print">
    <header>
        <h1>æ—¥å ±é›†ç´„ãƒ»å€‹äººã‚«ãƒ«ãƒ†ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
        <p class="subtitle">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµ±åˆã—ã€ç‰¹å®šã®å¯¾è±¡è€…ã®æƒ…å ±ã‚’ã‚«ãƒ«ãƒ†å½¢å¼ã§å‡ºåŠ›ã—ã¾ã™</p>
    </header>

    <section>
        <div class="section-title"><span class="step-number">1</span><h2>Excelãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</h2></div>
        <div class="drop-zone" id="dropZone">
            <p style="font-size: 40px; margin: 0;">ğŸ“</p>
            <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã¾ãŸã¯ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</strong></p>
            <input type="file" id="fileInput" multiple accept=".xlsx, .xls, .csv">
        </div>
        <div id="columnSettings" class="hidden"><div class="settings-grid" id="settingsList"></div></div>
    </section>

    <section id="searchSection" class="hidden">
        <div class="section-title"><span class="step-number">2</span><h2>æ°åã®æ¤œç´¢ã¨é¸æŠ</h2></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æ¤œç´¢ã—ãŸã„æ°åã‚’å…¥åŠ›...">
            <button id="searchBtn" class="btn btn-primary">æ¤œç´¢å®Ÿè¡Œ</button>
        </div>
        <div id="resultsArea" class="hidden">
            <div id="nameList"></div>
            <div style="margin-top: 40px; text-align: center;"><button id="generateBtn" class="btn btn-success">ã‚«ãƒ«ãƒ†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ</button></div>
        </div>
    </section>
</div>

<div id="printArea" class="hidden"></div>
<div id="previewControls" class="no-print hidden">
    <button id="closePreviewBtn" class="btn btn-primary" style="background: #334155; padding: 15px 40px;">æˆ»ã‚‹</button>
    <button id="printBtn" class="btn btn-success" style="background: #ef4444; padding: 15px 60px;">PDFã¨ã—ã¦å‡ºåŠ›</button>
</div>

<script>
    /* --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æä¾›ã®Polyfillã‚³ãƒ¼ãƒ‰ --- */
    if(!Object.keys)Object.keys=function(){var t=Object.prototype.hasOwnProperty,e=!{toString:null}.propertyIsEnumerable("toString"),r=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],i=r.length;return function(n){if(typeof n!=="object"&&typeof n!=="function"||n===null)throw new TypeError("Object.keys called on non-object");var o=[];for(var a in n)if(t.call(n,a))o.push(a);if(e)for(var l=0;l<i;++l)if(t.call(n,r[l]))o.push(r[l]);return o}}();if(!String.prototype.trim)String.prototype.trim=function(){var t=this.replace(/^\s+/,"");for(var e=t.length-1;e>=0;--e)if(!t.charAt(e).match(/^\s/))return t.slice(0,e+1);return""};if(!Array.prototype.forEach)Array.prototype.forEach=function(t){var e=this.length>>>0,r=arguments[1]||void 0;for(var i=0;i<e;++i)if(i in this)r?t.call(r,this[i],i,this):t(this[i],i,this)};if(!Array.prototype.map)Array.prototype.map=function(t){var e=this.length>>>0,r=arguments[1]||void 0,i=new Array(e);for(var n=0;n<e;++n)if(n in this)i[n]=r?t.call(r,this[n],n,this):t(this[n],n,this);return i};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(t){var e=this.length>>>0,r=arguments[1]|0||0;for(r<0&&(r+=e)<0&&(r=0);r<e;++r)if(this[r]===t)return r;return-1};if(!Array.prototype.lastIndexOf)Array.prototype.lastIndexOf=function(t){var e=this.length>>>0,r=e-1;for(;r>=0;--r)if(this[r]===t)return r;return-1};if(!Array.isArray)Array.isArray=function(t){return Object.prototype.toString.call(t)==="[object Array]"};if(!Date.prototype.toISOString)Date.prototype.toISOString=function(){function t(t,e){return("0000000"+t).slice(-(e||2))}return function e(){var e=this.getUTCFullYear(),r="";if(e>9999)r="+"+t(e,6);else if(e<0)r="-"+t(-e,6);else r=t(e,4);return[r,t(this.getUTCMonth()+1),t(this.getUTCDate())].join("-")+"T"+[t(this.getUTCHours()),t(this.getUTCMinutes()),t(this.getUTCSeconds())].join(":")+"."+t(this.getUTCMilliseconds(),3)+"Z"}}();if(typeof ArrayBuffer!=="undefined"&&!ArrayBuffer.prototype.slice)ArrayBuffer.prototype.slice=function(t,e){if(t==null)t=0;if(t<0){t+=this.byteLength;if(t<0)t=0}if(t>=this.byteLength)return new Uint8Array(0);if(e==null)e=this.byteLength;if(e<0){e+=this.byteLength;if(e<0)e=0}if(e>this.byteLength)e=this.byteLength;if(t>e)return new Uint8Array(0);var r=new ArrayBuffer(e-t);var i=new Uint8Array(r);var n=new Uint8Array(this,t,e-t);if(i.set)i.set(n);else while(t<=--e)i[e-t]=n[e];return r};if(typeof Uint8Array!=="undefined"&&!Uint8Array.prototype.slice)Uint8Array.prototype.slice=function(t,e){if(t==null)t=0;if(t<0){t+=this.length;if(t<0)t=0}if(t>=this.length)return new Uint8Array(0);if(e==null)e=this.length;if(e<0){e+=this.length;if(e<0)e=0}if(e>this.length)e=this.length;if(t>e)return new Uint8Array(0);var r=new Uint8Array(e-t);while(t<=--e)r[e-t]=this[e];return r};if(typeof window!=="undefined"&&typeof window.getComputedStyle!=="function"){window.getComputedStyle=function(t,e){return this.el=t,this.getPropertyValue=function(e){var r=/(\-([a-z]){1})/g;return e=="float"&&(e="styleFloat"),r.test(e)&&(e=e.replace(r,function(){return arguments[2].toUpperCase()})),t.currentStyle[e]?t.currentStyle[e]:null},this}};

    // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
    let dataSources = [];
    const elements = {
        fileInput: document.getElementById('fileInput'),
        dropZone: document.getElementById('dropZone'),
        settingsList: document.getElementById('settingsList'),
        columnSettings: document.getElementById('columnSettings'),
        searchSection: document.getElementById('searchSection'),
        searchInput: document.getElementById('searchInput'),
        searchBtn: document.getElementById('searchBtn'),
        resultsArea: document.getElementById('resultsArea'),
        nameList: document.getElementById('nameList'),
        generateBtn: document.getElementById('generateBtn'),
        printArea: document.getElementById('printArea'),
        previewControls: document.getElementById('previewControls'),
        printBtn: document.getElementById('printBtn'),
        closePreviewBtn: document.getElementById('closePreviewBtn')
    };

    elements.dropZone.onclick = () => elements.fileInput.click();
    elements.fileInput.onchange = handleFiles;
    elements.dropZone.ondragover = (e) => { e.preventDefault(); elements.dropZone.style.borderColor = "#3b82f6"; };
    elements.dropZone.ondragleave = () => { elements.dropZone.style.borderColor = "#cbd5e1"; };
    elements.dropZone.ondrop = (e) => { e.preventDefault(); handleFiles({target: {files: e.dataTransfer.files}}); };

    async function handleFiles(e) {
        if (typeof XLSX === 'undefined') {
            alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(xlsx.full.min.js)ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«è¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€Excelã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚');
            return;
        }
        const files = Array.from(e.target.files);
        dataSources = [];
        for (const file of files) {
            try {
                const rawData = await readExcel(file);
                if (rawData && rawData.length > 0) {
                    const headers = rawData[0];
                    const rows = rawData.slice(1).map(row => {
                        let obj = {};
                        headers.forEach((h, i) => {
                            let val = row[i];
                            if (val instanceof Date) val = `${val.getFullYear()}/${val.getMonth()+1}/${val.getDate()}`;
                            obj[h] = val;
                        });
                        return obj;
                    });
                    let defaultCol = headers.find(h => String(h).includes("æ°å") || String(h).includes("åå‰")) || headers[0];
                    dataSources.push({ name: file.name, data: rows, headers: headers, nameCol: defaultCol });
                }
            } catch (err) { console.error(err); }
        }
        renderColumnSettings();
    }

    function readExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                } catch (err) { reject(err); }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function renderColumnSettings() {
        elements.settingsList.innerHTML = '';
        dataSources.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'setting-card';
            div.innerHTML = `<div class="source-label">FILE SOURCE</div><div class="source-name">${src.name}</div>
                <select onchange="dataSources[${idx}].nameCol = this.value">
                    ${src.headers.map(h => `<option value="${h}" ${h === src.nameCol ? 'selected' : ''}>${h}</option>`).join('')}
                </select>`;
            elements.settingsList.appendChild(div);
        });
        elements.columnSettings.classList.remove('hidden');
        elements.searchSection.classList.remove('hidden');
    }

    elements.searchBtn.onclick = () => {
        const query = elements.searchInput.value.trim();
        if (!query) return;
        const found = new Set();
        dataSources.forEach(src => {
            src.data.forEach(row => {
                const name = String(row[src.nameCol] || "");
                if (name.includes(query)) found.add(name);
            });
        });
        renderNameList(Array.from(found).sort());
    };

    function renderNameList(names) {
        elements.nameList.innerHTML = '';
        if (names.length === 0) {
            elements.nameList.innerHTML = '<p style="text-align:center; color:#94a3b8; width:100%;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        } else {
            names.forEach(name => {
                const label = document.createElement('label');
                label.className = 'name-item';
                label.innerHTML = `<input type="checkbox" name="targetName" value="${name}"><span>${name}</span>`;
                elements.nameList.appendChild(label);
            });
        }
        elements.resultsArea.classList.remove('hidden');
    }

    elements.generateBtn.onclick = () => {
        const selected = Array.from(document.querySelectorAll('input[name="targetName"]:checked')).map(el => el.value);
        if (selected.length === 0) return alert("å¯¾è±¡è€…ã‚’é¸æŠã—ã¦ãã ã•ã„");
        elements.printArea.innerHTML = '';
        selected.forEach(name => {
            let userRecords = [];
            dataSources.forEach(src => {
                const rows = src.data.filter(r => String(r[src.nameCol]) === name);
                rows.forEach(r => userRecords.push({ source: src.name, content: r, nameCol: src.nameCol }));
            });
            userRecords.sort((a, b) => {
                const getDate = (o) => {
                    const k = Object.keys(o.content).find(key => key.includes("æ—¥ä»˜") || key.includes("æœˆæ—¥"));
                    return o.content[k] || "";
                };
                return getDate(a) > getDate(b) ? 1 : -1;
            });
            const page = document.createElement('div');
            page.className = 'a4-page page-break';
            let html = `<div class="carte-header"><h1 class="carte-title">å€‹äººåˆ¥ç›¸è«‡è¨˜éŒ²ã‚«ãƒ«ãƒ†</h1><span style="font-size: 10px; color: #64748b;">ä½œæˆæ—¥: ${new Date().toLocaleDateString()}</span></div>
                <div class="patient-info"><span class="label-badge">å¯¾è±¡è€…æ°å</span><span class="patient-name">${name} <small style="font-size:14px; font-weight:normal; color:#64748b;">æ§˜</small></span></div><div class="records-container">`;
            userRecords.forEach(rec => {
                html += `<div class="record-card"><div class="record-source">ğŸ“ å‚ç…§å…ƒ: ${rec.source}</div>`;
                Object.keys(rec.content).forEach(key => {
                    if (key === rec.nameCol) return;
                    const val = rec.content[key];
                    if (val === "" || val === null || val === undefined) return;
                    html += `<div class="item-row"><div class="item-label">${key}</div><div class="item-value">${val}</div></div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
            page.innerHTML = html;
            elements.printArea.appendChild(page);
        });
        document.querySelector('.container').classList.add('hidden');
        elements.printArea.classList.remove('hidden');
        elements.previewControls.classList.remove('hidden');
    };

    elements.closePreviewBtn.onclick = () => {
        document.querySelector('.container').classList.remove('hidden');
        elements.printArea.classList.add('hidden');
        elements.previewControls.classList.add('hidden');
    };

    elements.printBtn.onclick = () => {
        const originalTitle = document.title;
        const now = new Date();
        document.title = `ã‚«ãƒ«ãƒ†_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        window.print();
        document.title = originalTitle;
    };
</script>
</body>
</html>
