<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日報集約・個人カルテ作成ツール</title>
    <!-- オフライン対応：同じディレクトリにあるJSファイルを読み込む -->
    <script src="xlsx.full.min.js"></script>
    <style>
        /* --- 外部依存なしのCSS --- */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f1f5f9;
            color: #0f172a;
            margin: 0;
            line-height: 1.5;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 2.25rem; font-weight: 800; color: #1e293b; margin-bottom: 8px; }
        .subtitle { color: #64748b; font-size: 0.95rem; }
        section { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .section-title { display: flex; align-items: center; font-size: 1.25rem; font-weight: bold; margin-bottom: 24px; }
        .step-number { background: #2563eb; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 0.875rem; }
        
        /* ファイル入力 */
        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 40px; text-align: center; background: #f8fafc; cursor: pointer; transition: all 0.2s; }
        .drop-zone:hover { border-color: #3b82f6; background: #eff6ff; }
        .drop-zone svg { width: 48px; height: 48px; margin-bottom: 12px; color: #94a3b8; }
        #fileInput { display: none; }

        /* カラム設定 */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
        .setting-card { padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; }
        .source-label { font-size: 0.625rem; font-weight: bold; color: #2563eb; text-transform: uppercase; margin-bottom: 4px; }
        .source-name { font-size: 0.875rem; font-weight: bold; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.875rem; outline: none; background-color: white; }

        /* 検索 */
        .search-box { display: flex; gap: 12px; margin-bottom: 30px; }
        input[type="text"] { flex-grow: 1; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 12px; font-size: 1rem; outline: none; }
        input[type="text"]:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: #1e293b; color: white; }
        .btn-success { background: #2563eb; color: white; font-size: 1.125rem; padding: 16px 40px; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        
        #nameList { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; max-height: 300px; overflow-y: auto; padding: 10px; }
        .name-item { display: flex; align-items: center; padding: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; cursor: pointer; }
        .name-item:hover { border-color: #3b82f6; background: #f0f7ff; }
        .name-item input { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }

        /* カルテプレビュー・印刷 */
        #printArea { background: #94a3b8; padding: 20px 0; }
        .a4-page { width: 210mm; min-height: 297mm; padding: 15mm; margin: 0 auto 10mm auto; background: white; box-sizing: border-box; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        .carte-header { border-bottom: 2px solid #1a365d; margin-bottom: 20px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .carte-title { font-size: 24px; font-weight: 900; margin: 0; color: #1a365d; }
        .patient-info { border: 2px solid #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: baseline; }
        .label-badge { font-size: 12px; background: #1e293b; color: white; padding: 4px 8px; margin-right: 16px; font-weight: bold; }
        .patient-name { font-size: 32px; font-weight: bold; }
        
        .record-card { border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 24px; overflow: hidden; break-inside: avoid; }
        .record-source { background: #f1f5f9; padding: 8px 16px; font-size: 11px; font-weight: bold; color: #475569; border-bottom: 1px solid #cbd5e1; }
        .item-row { display: flex; border-bottom: 1px solid #f1f5f9; }
        .item-row:last-child { border-bottom: none; }
        .item-label { width: 140px; background: #f8fafc; padding: 10px 15px; font-size: 12px; font-weight: bold; color: #64748b; border-right: 1px solid #f1f5f9; flex-shrink: 0; display: flex; align-items: center; }
        .item-value { padding: 10px 15px; font-size: 14px; flex-grow: 1; white-space: pre-wrap; word-break: break-all; }

        #previewControls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 100; }
        .hidden { display: none !important; }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #printArea { background: white; padding: 0; }
            .a4-page { margin: 0; box-shadow: none; width: 100%; border: none; }
            .page-break { page-break-after: always; }
            @page { size: A4 portrait; margin: 0; }
        }
    </style>
</head>
<body>

<div class="container no-print">
    <header>
        <h1>日報集約・個人カルテ作成ツール</h1>
        <p class="subtitle">複数のExcel/CSVから特定個人の相談内容を抽出し、1枚のカルテとして集約します</p>
    </header>

    <section>
        <div class="section-title"><span class="step-number">1</span><h2>データの読み込み</h2></div>
        <div class="drop-zone" id="dropZone">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            <p><strong>ファイルを選択、またはここにドラッグ＆ドロップ</strong></p>
            <p style="font-size: 0.75rem; color: #94a3b8;">Excel (.xlsx / .xls) または CSV (.csv)</p>
            <input type="file" id="fileInput" multiple accept=".xlsx, .xls, .csv">
        </div>
        <div id="columnSettings" class="hidden"><div class="settings-grid" id="settingsList"></div></div>
    </section>

    <section id="searchSection" class="hidden">
        <div class="section-title"><span class="step-number">2</span><h2>氏名の検索と選択</h2></div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="検索したい氏名を入力...">
            <button id="searchBtn" class="btn btn-primary">検索実行</button>
        </div>
        <div id="resultsArea" class="hidden">
            <div id="nameList"></div>
            <div style="margin-top: 40px; text-align: center;"><button id="generateBtn" class="btn btn-success">カルテプレビューを生成</button></div>
        </div>
    </section>
</div>

<!-- プレビューエリア -->
<div id="printArea" class="hidden"></div>

<!-- プレビュー操作パネル -->
<div id="previewControls" class="no-print hidden">
    <button id="closePreviewBtn" class="btn btn-primary" style="background: #334155; padding: 15px 40px;">戻る</button>
    <button id="printBtn" class="btn btn-success" style="background: #ef4444; padding: 15px 60px;">PDFとして出力</button>
</div>

<script>
    // --- グローバル状態 ---
    let dataSources = [];

    // --- DOM要素 ---
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const settingsList = document.getElementById('settingsList');
    const columnSettings = document.getElementById('columnSettings');
    const searchSection = document.getElementById('searchSection');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsArea = document.getElementById('resultsArea');
    const nameList = document.getElementById('nameList');
    const generateBtn = document.getElementById('generateBtn');
    const printArea = document.getElementById('printArea');
    const previewControls = document.getElementById('previewControls');
    const printBtn = document.getElementById('printBtn');
    const closePreviewBtn = document.getElementById('closePreviewBtn');

    // --- イベントリスナー ---
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = handleFiles;
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = "#3b82f6"; };
    dropZone.ondragleave = () => { dropZone.style.borderColor = "#cbd5e1"; };
    dropZone.ondrop = (e) => { e.preventDefault(); handleFiles({target: {files: e.dataTransfer.files}}); };

    async function handleFiles(e) {
        if (typeof XLSX === 'undefined') {
            alert('xlsx.full.min.js が見つかりません。同じディレクトリに配置してください。');
            return;
        }
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        dataSources = [];
        for (const file of files) {
            try {
                const rawData = await readData(file);
                if (rawData && rawData.length > 0) {
                    const headers = rawData[0];
                    const rows = rawData.slice(1).map(row => {
                        let obj = {};
                        headers.forEach((h, i) => {
                            let val = row[i];
                            // 日付型の場合は自動フォーマット
                            if (val instanceof Date) {
                                val = `${val.getFullYear()}/${val.getMonth()+1}/${val.getDate()}`;
                            }
                            obj[h] = val;
                        });
                        return obj;
                    });
                    
                    // 「氏名」「名前」を含む列を自動抽出
                    let defaultCol = headers.find(h => String(h).includes("氏名") || String(h).includes("名前")) || headers[0];
                    dataSources.push({ name: file.name, data: rows, headers: headers, nameCol: defaultCol });
                }
            } catch (err) {
                console.error(err);
                alert(file.name + " の読み込みに失敗しました。");
            }
        }
        renderColumnSettings();
    }

    // Excel または CSV を読み込む（文字化け対策：UTF-8優先→Shift-JIS fallback）
    function readData(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        const fileName = file.name.toLowerCase();

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            let workbook;

            if (fileName.endsWith('.csv')) {
              // 1) UTF-8 を試す（BOM除去もする）
              const utf8 = new TextDecoder('utf-8').decode(data).replace(/^\uFEFF/, '');

              // “明らかに文字化け”っぽい記号が多いときは Shift-JIS を試す
              const looksGarbled = (s) => {
                const bad = (s.match(/\uFFFD/g) || []).length;
                return bad >= 2;
              };

              let csvText = utf8;
              if (looksGarbled(utf8)) {
                // 2) Shift-JIS（CP932）で再デコード
                csvText = new TextDecoder('shift-jis').decode(data);
              }
              workbook = XLSX.read(csvText, { type: 'string' });
            } else {
              // .xlsx / .xls
              workbook = XLSX.read(data, {
                type: 'array',
                cellDates: true,
                codepage: 932, 
              });
            }

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            resolve(XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false }));
          } catch (err) {
            reject(err);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function renderColumnSettings() {
        settingsList.innerHTML = '';
        dataSources.forEach((src, idx) => {
            const div = document.createElement('div');
            div.className = 'setting-card';
            div.innerHTML = `
                <div class="source-label">FILE SOURCE</div>
                <div class="source-name">${src.name}</div>
                <select onchange="dataSources[${idx}].nameCol = this.value">
                    ${src.headers.map(h => `<option value="${h}" ${h === src.nameCol ? 'selected' : ''}>${h}</option>`).join('')}
                </select>
            `;
            settingsList.appendChild(div);
        });
        columnSettings.classList.remove('hidden');
        searchSection.classList.remove('hidden');
    }

    searchBtn.onclick = () => {
        const query = searchInput.value.trim();
        if (!query) return;
        const found = new Set();
        dataSources.forEach(src => {
            src.data.forEach(row => {
                const name = String(row[src.nameCol] || "");
                if (name.includes(query)) found.add(name);
            });
        });
        renderNameList(Array.from(found).sort());
    };

    function renderNameList(names) {
        nameList.innerHTML = '';
        if (names.length === 0) {
            nameList.innerHTML = '<p style="text-align:center; color:#94a3b8; width:100%; padding:20px;">見つかりませんでした</p>';
        } else {
            names.forEach(name => {
                const label = document.createElement('label');
                label.className = 'name-item';
                label.innerHTML = `<input type="checkbox" name="targetName" value="${name}"><span>${name}</span>`;
                nameList.appendChild(label);
            });
        }
        resultsArea.classList.remove('hidden');
    }

    generateBtn.onclick = () => {
        const selected = Array.from(document.querySelectorAll('input[name="targetName"]:checked')).map(el => el.value);
        if (selected.length === 0) return alert("対象者を選択してください");

        printArea.innerHTML = '';
        selected.forEach(name => {
            let userRecords = [];
            dataSources.forEach(src => {
                const rows = src.data.filter(r => String(r[src.nameCol]) === name);
                rows.forEach(r => userRecords.push({ source: src.name, content: r, nameCol: src.nameCol }));
            });

            // 日付に近いカラム名を探してソート
            userRecords.sort((a, b) => {
                const getDate = (o) => {
                    const k = Object.keys(o.content).find(key => key.includes("日付") || key.includes("月日"));
                    return o.content[k] || "";
                };
                return getDate(a) > getDate(b) ? 1 : -1;
            });

            const page = document.createElement('div');
            page.className = 'a4-page page-break';
            let html = `
                <div class="carte-header">
                    <h1 class="carte-title">個人別相談記録カルテ</h1>
                    <span style="font-size: 10px; color: #64748b;">作成日: ${new Date().toLocaleDateString()}</span>
                </div>
                <div class="patient-info">
                    <span class="label-badge">対象者氏名</span>
                    <span class="patient-name">${name} <small style="font-size:14px; font-weight:normal; color:#64748b;">様</small></span>
                </div>
                <div class="records-container">
            `;

            userRecords.forEach(rec => {
                html += `<div class="record-card"><div class="record-source">データソース: ${rec.source}</div>`;
                Object.keys(rec.content).forEach(key => {
                    if (key === rec.nameCol) return; // 名前はヘッダーにあるためスキップ
                    const val = rec.content[key];
                    if (val === "" || val === null || val === undefined) return; // 空白は非表示
                    
                    html += `
                        <div class="item-row">
                            <div class="item-label">${key}</div>
                            <div class="item-value">${val}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            });

            if (userRecords.length === 0) html += `<p style="text-align:center; padding: 40px; color:#cbd5e1;">該当する記録はありません</p>`;
            
            html += `</div>`;
            page.innerHTML = html;
            printArea.appendChild(page);
        });

        document.querySelector('.container').classList.add('hidden');
        printArea.classList.remove('hidden');
        previewControls.classList.remove('hidden');
        window.scrollTo(0,0);
    };

    closePreviewBtn.onclick = () => {
        document.querySelector('.container').classList.remove('hidden');
        printArea.classList.add('hidden');
        previewControls.classList.add('hidden');
    };

    printBtn.onclick = () => {
        const originalTitle = document.title;
        const now = new Date();
        const dateStr = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
        const timeStr = String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0') + String(now.getSeconds()).padStart(2,'0');
        
        document.title = `相談カルテ_${dateStr}_${timeStr}`;
        window.print();
        document.title = originalTitle;
    };
</script>

</body>
</html>
